<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>APEX Mission Board | Seven Figure Agency</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&family=Noto+Sans+JP:wght@700;900&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sfa-red: #cc0000;
            --sfa-red-dark: #990000;
            --sfa-red-glow: rgba(204, 0, 0, 0.3);
            --gold: #ffd93d;
            --gold-dark: #e6c235;
            --green: #2ed573;
            --green-glow: rgba(46, 213, 115, 0.3);
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-card-hover: #1a1a1a;
            --border: #252525;
            --text: #ffffff;
            --text-secondary: #999;
            --text-muted: #555;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === BACKGROUND PATTERN === */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 0%, rgba(204,0,0,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(204,0,0,0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 40px 28px 70px;
            position: relative;
            z-index: 1;
        }

        /* === HEADER === */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .sfa-brand {
            font-size: 13px;
            letter-spacing: 6px;
            color: var(--sfa-red);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .kanji-accent {
            font-family: 'Noto Sans JP', serif;
            font-size: 100px;
            font-weight: 900;
            color: rgba(204, 0, 0, 0.06);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            user-select: none;
        }

        .apex-title {
            font-size: 62px;
            font-weight: 900;
            letter-spacing: 2px;
            line-height: 1;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #fff 0%, #ccc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .apex-title span {
            background: linear-gradient(135deg, var(--sfa-red) 0%, #ff3333 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 300;
            letter-spacing: 1.5px;
        }

        /* === VERSION / META BAR === */
        .meta-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .meta-label {
            color: var(--text-muted);
        }

        .meta-value {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .meta-value.version {
            color: var(--sfa-red);
        }

        .meta-value.week {
            color: var(--gold);
        }

        .meta-dot {
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: var(--border);
        }

        /* === SYNC STATUS === */
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-top: 10px;
        }

        .sync-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: background 0.3s;
        }

        .sync-dot.connected { background: var(--green); }
        .sync-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--sfa-red); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* === WEEK CONTROLS === */
        .week-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .week-btn {
            padding: 10px 22px;
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .week-btn:hover {
            border-color: var(--sfa-red);
            color: var(--text);
            background: rgba(204, 0, 0, 0.05);
        }

        .week-btn.danger:hover {
            border-color: #ff4444;
            color: #ff4444;
            background: rgba(255, 68, 68, 0.05);
        }

        /* === WEEK HISTORY === */
        .history-section {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .history-title {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-align: center;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .history-card {
            padding: 16px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
        }

        .history-week {
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .history-score {
            font-size: 28px;
            font-weight: 900;
            line-height: 1;
        }

        .history-score .h-done { color: var(--green); }
        .history-score .h-slash { color: var(--text-muted); font-weight: 300; }
        .history-score .h-total { color: var(--text-secondary); font-size: 20px; }

        .history-rank {
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
            letter-spacing: 1px;
        }

        .history-rank.rank-ronin { color: #888; }
        .history-rank.rank-samurai { color: #ff6b6b; }
        .history-rank.rank-shogun { color: var(--sfa-red); }
        .history-rank.rank-daimyo { color: #ff8c00; }
        .history-rank.rank-apex { color: var(--gold); }
        .history-rank.rank-legend { color: var(--green); }

        .history-empty {
            text-align: center;
            font-size: 14px;
            color: var(--text-muted);
            padding: 20px;
        }

        /* === CONFIRM MODAL === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 36px;
            max-width: 440px;
            width: 90%;
            text-align: center;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .modal-text {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 28px;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.confirm {
            background: linear-gradient(145deg, var(--sfa-red) 0%, var(--sfa-red-dark) 100%);
            border-color: var(--sfa-red);
            color: white;
        }

        .modal-btn.confirm:hover {
            box-shadow: 0 4px 15px var(--sfa-red-glow);
        }

        .modal-btn:hover {
            border-color: #444;
            color: var(--text);
        }

        /* === ADD TASK MODAL === */
        .add-task-form {
            text-align: left;
        }

        .add-task-form label {
            display: block;
            font-size: 12px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
            margin-top: 14px;
        }

        .add-task-form label:first-child {
            margin-top: 0;
        }

        .add-task-form input,
        .add-task-form select {
            width: 100%;
            padding: 10px 14px;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            outline: none;
            transition: border-color 0.3s;
        }

        .add-task-form input:focus,
        .add-task-form select:focus {
            border-color: var(--sfa-red);
        }

        .add-task-form select option {
            background: var(--bg-dark);
        }

        /* === APEX PILLARS === */
        .pillars {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 28px 0 36px;
        }

        .pillar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .pillar:hover {
            border-color: var(--sfa-red);
            background: rgba(204, 0, 0, 0.05);
        }

        .pillar-letter {
            color: var(--sfa-red);
            font-size: 20px;
            font-weight: 900;
        }

        .pillar-word {
            color: var(--text-secondary);
        }

        /* === RANK & PROGRESS === */
        .stats-bar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 24px;
            align-items: center;
            margin-bottom: 40px;
            padding: 28px 36px;
            background: linear-gradient(135deg, var(--bg-card) 0%, #111 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .rank-section {
            text-align: left;
        }

        .rank-label {
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .rank-name {
            font-size: 28px;
            font-weight: 800;
            color: var(--gold);
            line-height: 1.2;
        }

        .rank-name.rank-ronin { color: #888; }
        .rank-name.rank-samurai { color: #ff6b6b; }
        .rank-name.rank-shogun { color: var(--sfa-red); }
        .rank-name.rank-daimyo { color: #ff8c00; }
        .rank-name.rank-apex { color: var(--gold); }
        .rank-name.rank-legend { color: var(--green); }

        .stats-divider {
            width: 1px;
            height: 50px;
            background: var(--border);
        }

        .progress-section {
            text-align: right;
        }

        .progress-numbers {
            font-size: 44px;
            font-weight: 900;
            line-height: 1;
        }

        .progress-numbers .done {
            color: var(--green);
        }

        .progress-numbers .slash {
            color: var(--text-muted);
            font-weight: 300;
            margin: 0 2px;
        }

        .progress-numbers .total {
            color: var(--text-secondary);
        }

        .progress-label {
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* === XP BAR === */
        .xp-bar-container {
            margin-bottom: 44px;
        }

        .xp-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .xp-label {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--text-secondary);
        }

        .xp-percent {
            font-size: 15px;
            font-weight: 700;
            color: var(--green);
        }

        .xp-bar {
            height: 10px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--sfa-red) 0%, var(--sfa-red) 60%, var(--green) 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* === RANK MILESTONES === */
        .rank-milestones {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 0 2px;
        }

        .milestone {
            font-size: 11px;
            letter-spacing: 1px;
            color: var(--text-muted);
            text-transform: uppercase;
            transition: color 0.3s;
            text-align: center;
        }

        .milestone.active {
            color: var(--gold);
        }

        .milestone.cleared {
            color: var(--text-secondary);
        }

        /* === MISSION TIERS === */
        .tier {
            margin-bottom: 32px;
        }

        .tier-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .tier-icon {
            font-size: 24px;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .tier-info {
            flex: 1;
        }

        .tier-name {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .tier-meta {
            font-size: 13px;
            color: var(--text-muted);
        }

        .tier-count {
            font-size: 14px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .tier-count.complete {
            color: var(--green);
            border-color: rgba(46, 213, 115, 0.3);
            background: rgba(46, 213, 115, 0.05);
        }

        /* === TASK ITEMS === */
        .task {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 18px 22px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .task:hover {
            border-color: #333;
            background: var(--bg-card-hover);
            transform: translateX(4px);
        }

        .task.completed {
            opacity: 0.45;
            border-color: rgba(46, 213, 115, 0.15);
        }

        .task.completed:hover {
            opacity: 0.65;
        }

        .task.completed .task-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .task.completed .task-detail {
            text-decoration: line-through;
        }

        /* Completion flash */
        .task.just-completed {
            animation: taskComplete 0.6s ease;
        }

        @keyframes taskComplete {
            0% { border-color: var(--border); }
            30% { border-color: var(--green); box-shadow: 0 0 20px var(--green-glow); }
            100% { border-color: rgba(46, 213, 115, 0.15); box-shadow: none; }
        }

        .task.just-uncompleted {
            animation: taskUncomplete 0.4s ease;
        }

        @keyframes taskUncomplete {
            0% { border-color: rgba(46, 213, 115, 0.15); }
            30% { border-color: var(--sfa-red); }
            100% { border-color: var(--border); }
        }

        .checkbox {
            width: 28px;
            height: 28px;
            min-width: 28px;
            border: 2px solid #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-top: 1px;
        }

        .task:hover .checkbox {
            border-color: var(--sfa-red);
        }

        .task.completed .checkbox {
            background: var(--green);
            border-color: var(--green);
        }

        .checkbox svg {
            width: 18px;
            height: 18px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .task.completed .checkbox svg {
            opacity: 1;
            transform: scale(1);
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-text {
            font-size: 17px;
            font-weight: 600;
            line-height: 1.4;
            transition: all 0.3s;
        }

        .task-detail {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
            transition: all 0.3s;
        }

        .task-xp {
            font-size: 13px;
            font-weight: 700;
            color: var(--gold);
            white-space: nowrap;
            margin-top: 2px;
        }

        /* === COMPLETION CELEBRATION === */
        .celebration {
            display: none;
            text-align: center;
            padding: 40px;
            margin-top: 20px;
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.05) 0%, rgba(204, 0, 0, 0.05) 100%);
            border: 1px solid rgba(46, 213, 115, 0.2);
            border-radius: 20px;
            animation: celebrationPulse 2s infinite;
        }

        .celebration.show {
            display: block;
        }

        @keyframes celebrationPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(46, 213, 115, 0.1); }
            50% { box-shadow: 0 0 40px rgba(46, 213, 115, 0.2); }
        }

        .celebration-kanji {
            font-family: 'Noto Sans JP', serif;
            font-size: 72px;
            font-weight: 900;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .celebration-title {
            font-size: 34px;
            font-weight: 900;
            color: var(--green);
            margin-bottom: 6px;
        }

        .celebration-sub {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* === FOOTER === */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .footer-brand {
            font-size: 12px;
            letter-spacing: 5px;
            color: var(--sfa-red);
            font-weight: 700;
        }

        .footer-sub {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* === KATANA DIVIDER === */
        .katana-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 30px 0;
            color: var(--text-muted);
        }

        .katana-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--border) 50%, transparent 100%);
        }

        .katana-symbol {
            font-size: 10px;
            letter-spacing: 4px;
        }

        /* === LOADING STATE === */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .loading-state .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--sfa-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === RESPONSIVE === */
        @media (max-width: 640px) {
            .container { padding: 24px 16px 40px; }
            .apex-title { font-size: 42px; }
            .pillars { flex-wrap: wrap; }
            .pillar { padding: 8px 14px; font-size: 12px; }
            .stats-bar { grid-template-columns: 1fr; gap: 16px; text-align: center; padding: 22px; }
            .rank-section, .progress-section { text-align: center; }
            .stats-divider { width: 100%; height: 1px; }
            .task { padding: 16px 16px; }
            .task-text { font-size: 15px; }
            .task-detail { font-size: 13px; }
            .meta-bar { gap: 16px; }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="kanji-accent">&#38914;</div>
        <div class="sfa-brand">SEVEN FIGURE AGENCY</div>
        <div class="apex-title">TEAM <span>APEX</span></div>
        <div class="subtitle">Mission Board</div>

        <!-- VERSION / META BAR -->
        <div class="meta-bar">
            <div class="meta-item">
                <span class="meta-label">Version</span>
                <span class="meta-value version" id="metaVersion">2.0</span>
            </div>
            <div class="meta-dot"></div>
            <div class="meta-item">
                <span class="meta-label">Week</span>
                <span class="meta-value week" id="metaWeek">--</span>
            </div>
            <div class="meta-dot"></div>
            <div class="meta-item">
                <span class="meta-label">Updated</span>
                <span class="meta-value" id="metaUpdated">--</span>
            </div>
        </div>

        <div class="sync-indicator">
            <div class="sync-dot" id="syncDot"></div>
            <span id="syncText">Connecting...</span>
        </div>
    </div>

    <!-- APEX PILLARS -->
    <div class="pillars">
        <div class="pillar"><span class="pillar-letter">A</span><span class="pillar-word">Accountable</span></div>
        <div class="pillar"><span class="pillar-letter">P</span><span class="pillar-word">Peak Performance</span></div>
        <div class="pillar"><span class="pillar-letter">E</span><span class="pillar-word">Excellence</span></div>
        <div class="pillar"><span class="pillar-letter">X</span><span class="pillar-word">10X</span></div>
    </div>

    <!-- STATS BAR -->
    <div class="stats-bar">
        <div class="rank-section">
            <div class="rank-label">Current Rank</div>
            <div class="rank-name" id="rankName">Ronin</div>
        </div>
        <div class="stats-divider"></div>
        <div class="progress-section">
            <div class="progress-numbers">
                <span class="done" id="doneCount">0</span><span class="slash">/</span><span class="total" id="totalCount">0</span>
            </div>
            <div class="progress-label">Missions Complete</div>
        </div>
    </div>

    <!-- XP BAR -->
    <div class="xp-bar-container">
        <div class="xp-bar-header">
            <span class="xp-label">APEX PROGRESS</span>
            <span class="xp-percent" id="xpPercent">0%</span>
        </div>
        <div class="xp-bar">
            <div class="xp-fill" id="xpFill" style="width: 0%"></div>
        </div>
        <div class="rank-milestones">
            <div class="milestone active" data-threshold="0">Ronin</div>
            <div class="milestone" data-threshold="20">Samurai</div>
            <div class="milestone" data-threshold="40">Shogun</div>
            <div class="milestone" data-threshold="60">Daimyo</div>
            <div class="milestone" data-threshold="80">Apex</div>
            <div class="milestone" data-threshold="100">Legend</div>
        </div>
    </div>

    <!-- DYNAMIC TASKS CONTAINER -->
    <div id="tasksContainer">
        <div class="loading-state">
            <div class="spinner"></div>
            <div>Loading missions...</div>
        </div>
    </div>

    <!-- CELEBRATION -->
    <div class="celebration" id="celebration">
        <div class="celebration-kanji">&#20253;&#35500;</div>
        <div class="celebration-title">APEX LEGEND ACHIEVED</div>
        <div class="celebration-sub" id="celebrationSub">All missions complete. You are the standard.</div>
    </div>

    <!-- WEEK CONTROLS -->
    <div class="week-controls">
        <button class="week-btn" onclick="showAddTaskModal()">+ Add Mission</button>
        <button class="week-btn danger" onclick="showResetModal()">New Week</button>
    </div>

    <!-- WEEK HISTORY -->
    <div class="history-section">
        <div class="history-title">Previous Weeks</div>
        <div id="historyGrid" class="history-grid">
            <div class="history-empty">No previous weeks yet. Complete your first week to start building history.</div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        <div class="footer-brand">SEVEN FIGURE AGENCY</div>
        <div class="footer-sub">Team Apex Mission Board &bull; v<span id="footerVersion">2.0</span></div>
    </div>

    <!-- CONFIRM NEW WEEK MODAL -->
    <div class="modal-overlay" id="resetModal">
        <div class="modal">
            <div class="modal-title">Start New Week?</div>
            <div class="modal-text">This will archive your current progress. Completed tasks get archived. Uncompleted tasks carry forward to the new week.</div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="hideResetModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmNewWeek()">Start Fresh</button>
            </div>
        </div>
    </div>

    <!-- ADD TASK MODAL -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal">
            <div class="modal-title">New Mission</div>
            <div class="add-task-form">
                <label for="newTaskText">Mission Name</label>
                <input type="text" id="newTaskText" placeholder="What needs to be done?">

                <label for="newTaskDetail">Detail (optional)</label>
                <input type="text" id="newTaskDetail" placeholder="Additional context...">

                <label for="newTaskTier">Tier</label>
                <select id="newTaskTier">
                    <option value="0">Quick Wins (+10 XP)</option>
                    <option value="1">Scheduling (+15 XP)</option>
                    <option value="2">Quick Tasks (+20 XP)</option>
                    <option value="3">Moderate Effort (+30 XP)</option>
                    <option value="4">Heavy Lifts (+50 XP)</option>
                </select>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn" onclick="hideAddTaskModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="submitNewTask()">Add Mission</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === CONFIGURATION ===
    const BOARD_VERSION = '2.0';
    const API_BASE = '/api';
    const POLL_INTERVAL = 30000; // 30 seconds

    const TIER_CONFIG = [
        { index: 0, name: 'Quick Wins', icon: '\u26A1', meta: 'Under 5 minutes each - warm up the blade', xp: 10 },
        { index: 1, name: 'Scheduling', icon: '\uD83D\uDCC5', meta: '5-15 minutes each - set the battlefield', xp: 15 },
        { index: 2, name: 'Quick Tasks', icon: '\uD83D\uDCAB', meta: '10-20 minutes each - sharpen the edge', xp: 20 },
        { index: 3, name: 'Moderate Effort', icon: '\u2699\uFE0F', meta: '20-45 minutes each - test your discipline', xp: 30 },
        { index: 4, name: 'Heavy Lifts', icon: '\uD83D\uDD25', meta: '45+ minutes each - prove you are Apex', xp: 50 },
    ];

    const RANKS = [
        { threshold: 0,   name: 'Ronin',        class: 'rank-ronin' },
        { threshold: 20,  name: 'Samurai',       class: 'rank-samurai' },
        { threshold: 40,  name: 'Shogun',        class: 'rank-shogun' },
        { threshold: 60,  name: 'Daimyo',        class: 'rank-daimyo' },
        { threshold: 80,  name: 'Apex Warrior',  class: 'rank-apex' },
        { threshold: 100, name: 'Apex Legend',    class: 'rank-legend' }
    ];

    // === BOARD STATE (in-memory cache) ===
    let boardState = null;
    let pollTimer = null;
    let isSyncing = false;

    // === API HELPERS ===
    async function apiFetch(path, options = {}) {
        const res = await fetch(API_BASE + path, {
            headers: { 'Content-Type': 'application/json' },
            ...options,
        });
        return res.json();
    }

    async function loadBoard() {
        setSyncStatus('syncing', 'Syncing...');
        try {
            const data = await apiFetch('/board');
            if (data.error) throw new Error(data.error);
            boardState = data;
            setSyncStatus('connected', 'Live');
            renderAll();
        } catch (err) {
            console.error('Failed to load board:', err);
            setSyncStatus('error', 'Offline');
        }
    }

    // === SYNC STATUS ===
    function setSyncStatus(status, text) {
        const dot = document.getElementById('syncDot');
        const label = document.getElementById('syncText');
        dot.className = 'sync-dot ' + status;
        label.textContent = text;
    }

    // === UTILITIES ===
    function formatTimestamp(ts) {
        if (!ts) return '--';
        const d = new Date(ts);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) +
            ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    function getRankForPercent(percent) {
        let r = RANKS[0];
        for (const rank of RANKS) { if (percent >= rank.threshold) r = rank; }
        return r;
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // === TASK TOGGLE (via API) ===
    async function toggleTask(id) {
        if (isSyncing) return;
        isSyncing = true;

        // Optimistic UI update
        const el = document.querySelector(`.task[data-id="${id}"]`);
        const idStr = String(id);
        const wasCompleted = boardState.tasks && boardState.tasks[idStr];

        if (wasCompleted) {
            delete boardState.tasks[idStr];
            if (el) {
                el.classList.remove('completed', 'just-completed');
                el.classList.add('just-uncompleted');
                setTimeout(() => el.classList.remove('just-uncompleted'), 400);
            }
        } else {
            if (!boardState.tasks) boardState.tasks = {};
            boardState.tasks[idStr] = { completedAt: new Date().toISOString() };
            if (el) {
                el.classList.add('completed', 'just-completed');
                el.classList.remove('just-uncompleted');
                setTimeout(() => el.classList.remove('just-completed'), 600);
            }
        }

        updateStats();

        // Persist to API
        try {
            setSyncStatus('syncing', 'Saving...');
            const result = await apiFetch('/tasks', {
                method: 'PUT',
                body: JSON.stringify({ id: idStr }),
            });
            if (result.error) throw new Error(result.error);
            boardState.lastUpdated = result.lastUpdated;
            document.getElementById('metaUpdated').textContent = formatTimestamp(result.lastUpdated);
            setSyncStatus('connected', 'Live');
        } catch (err) {
            console.error('Toggle failed:', err);
            setSyncStatus('error', 'Save failed');
            // Revert on error
            if (wasCompleted) {
                boardState.tasks[idStr] = { completedAt: new Date().toISOString() };
            } else {
                delete boardState.tasks[idStr];
            }
            renderAll();
        }

        isSyncing = false;
    }

    // === RENDER TASKS DYNAMICALLY ===
    function renderTasks() {
        const container = document.getElementById('tasksContainer');
        if (!boardState || !boardState.taskList || boardState.taskList.length === 0) {
            container.innerHTML = '<div class="loading-state"><div>No missions loaded. Hit /api/migrate to seed the board.</div></div>';
            return;
        }

        // Group tasks by tier
        const tierGroups = {};
        TIER_CONFIG.forEach(t => { tierGroups[t.index] = []; });

        boardState.taskList.forEach(task => {
            const tier = task.tier !== undefined ? task.tier : 0;
            if (!tierGroups[tier]) tierGroups[tier] = [];
            tierGroups[tier].push(task);
        });

        let html = '';
        let tierIndex = 0;

        TIER_CONFIG.forEach((tierConf, idx) => {
            const tasks = tierGroups[tierConf.index] || [];
            if (tasks.length === 0) return;

            // Add katana divider before moderate effort (tier 3)
            if (tierConf.index === 3) {
                html += `<div class="katana-divider"><div class="katana-line"></div><div class="katana-symbol">\u2694\uFE0F</div><div class="katana-line"></div></div>`;
            }

            const completedInTier = tasks.filter(t => boardState.tasks && boardState.tasks[String(t.id)]).length;
            const isComplete = completedInTier === tasks.length;

            html += `<div class="tier" data-tier="${tierConf.index}">`;
            html += `<div class="tier-header">`;
            html += `<div class="tier-icon">${tierConf.icon}</div>`;
            html += `<div class="tier-info"><div class="tier-name">${escapeHtml(tierConf.name)}</div><div class="tier-meta">${escapeHtml(tierConf.meta)}</div></div>`;
            html += `<div class="tier-count${isComplete ? ' complete' : ''}" id="count-${tierConf.index}">${completedInTier}/${tasks.length}</div>`;
            html += `</div>`;

            tasks.forEach(task => {
                const isCompleted = boardState.tasks && boardState.tasks[String(task.id)];
                html += `<div class="task${isCompleted ? ' completed' : ''}" data-id="${task.id}" onclick="toggleTask(${task.id})">`;
                html += `<div class="checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>`;
                html += `<div class="task-content">`;
                html += `<div class="task-text">${escapeHtml(task.text)}</div>`;
                if (task.detail) {
                    html += `<div class="task-detail">${escapeHtml(task.detail)}</div>`;
                }
                html += `</div>`;
                html += `<div class="task-xp">+${task.xp} XP</div>`;
                html += `</div>`;
            });

            html += `</div>`;
            tierIndex++;
        });

        container.innerHTML = html;
    }

    // === UPDATE STATS (counts, rank, XP bar, milestones) ===
    function updateStats() {
        if (!boardState || !boardState.taskList) return;

        const totalTasks = boardState.taskList.length;
        const done = boardState.tasks ? Object.keys(boardState.tasks).length : 0;
        const percent = totalTasks > 0 ? Math.round((done / totalTasks) * 100) : 0;

        // Meta bar
        document.getElementById('metaVersion').textContent = BOARD_VERSION;
        document.getElementById('footerVersion').textContent = BOARD_VERSION;
        document.getElementById('metaWeek').textContent = boardState.weekLabel || '--';
        document.getElementById('metaUpdated').textContent = formatTimestamp(boardState.lastUpdated);

        // Progress counts
        document.getElementById('doneCount').textContent = done;
        document.getElementById('totalCount').textContent = totalTasks;
        document.getElementById('xpPercent').textContent = percent + '%';
        document.getElementById('xpFill').style.width = percent + '%';

        // Rank
        const currentRank = getRankForPercent(percent);
        const rankEl = document.getElementById('rankName');
        rankEl.textContent = currentRank.name;
        rankEl.className = 'rank-name ' + currentRank.class;

        // Milestones
        document.querySelectorAll('.milestone').forEach(m => {
            const t = parseInt(m.dataset.threshold);
            m.classList.remove('active', 'cleared');
            if (percent >= t && percent < (t + 20 > 100 ? 101 : t + 20)) m.classList.add('active');
            else if (percent >= t) m.classList.add('cleared');
        });
        if (percent === 100) {
            document.querySelectorAll('.milestone').forEach(m => {
                m.classList.add('cleared');
                if (m.dataset.threshold === '100') { m.classList.remove('cleared'); m.classList.add('active'); }
            });
        }

        // Tier counts (update if rendered)
        TIER_CONFIG.forEach(tierConf => {
            const countEl = document.getElementById('count-' + tierConf.index);
            if (!countEl) return;
            const tasks = boardState.taskList.filter(t => (t.tier !== undefined ? t.tier : 0) === tierConf.index);
            const tierDone = tasks.filter(t => boardState.tasks && boardState.tasks[String(t.id)]).length;
            countEl.textContent = tierDone + '/' + tasks.length;
            if (tierDone === tasks.length && tasks.length > 0) countEl.classList.add('complete');
            else countEl.classList.remove('complete');
        });

        // Celebration
        const celebEl = document.getElementById('celebration');
        celebEl.classList.toggle('show', done === totalTasks && totalTasks > 0);
        document.getElementById('celebrationSub').textContent = 'All ' + totalTasks + ' missions complete. You are the standard.';
    }

    // === RENDER HISTORY ===
    function renderHistory() {
        const history = (boardState && boardState.history) || [];
        const grid = document.getElementById('historyGrid');

        if (history.length === 0) {
            grid.innerHTML = '<div class="history-empty">No previous weeks yet. Complete your first week to start building history.</div>';
            return;
        }

        grid.innerHTML = history.slice().reverse().map(h => `
            <div class="history-card">
                <div class="history-week">${escapeHtml(h.weekLabel)}</div>
                <div class="history-score">
                    <span class="h-done">${h.completed}</span><span class="h-slash">/</span><span class="h-total">${h.total}</span>
                </div>
                <div class="history-rank ${h.rankClass}">${escapeHtml(h.rank)}</div>
            </div>
        `).join('');
    }

    // === RENDER ALL ===
    function renderAll() {
        renderTasks();
        updateStats();
        renderHistory();
    }

    // === NEW WEEK ===
    function showResetModal() {
        document.getElementById('resetModal').classList.add('show');
    }

    function hideResetModal() {
        document.getElementById('resetModal').classList.remove('show');
    }

    async function confirmNewWeek() {
        hideResetModal();
        setSyncStatus('syncing', 'Archiving week...');

        try {
            const result = await apiFetch('/week', {
                method: 'POST',
                body: JSON.stringify({}),
            });

            if (result.error) throw new Error(result.error);

            // Reload full board state
            await loadBoard();
        } catch (err) {
            console.error('New week failed:', err);
            setSyncStatus('error', 'Failed');
        }
    }

    // === ADD TASK ===
    function showAddTaskModal() {
        document.getElementById('newTaskText').value = '';
        document.getElementById('newTaskDetail').value = '';
        document.getElementById('newTaskTier').value = '0';
        document.getElementById('addTaskModal').classList.add('show');
        setTimeout(() => document.getElementById('newTaskText').focus(), 100);
    }

    function hideAddTaskModal() {
        document.getElementById('addTaskModal').classList.remove('show');
    }

    async function submitNewTask() {
        const text = document.getElementById('newTaskText').value.trim();
        if (!text) return;

        const detail = document.getElementById('newTaskDetail').value.trim();
        const tier = parseInt(document.getElementById('newTaskTier').value);
        const xp = TIER_CONFIG.find(t => t.index === tier)?.xp || 10;

        hideAddTaskModal();
        setSyncStatus('syncing', 'Adding mission...');

        try {
            const result = await apiFetch('/tasks', {
                method: 'POST',
                body: JSON.stringify({ text, detail, xp, tier }),
            });

            if (result.error) throw new Error(result.error);

            // Add to local state and re-render
            boardState.taskList.push(result.task);
            boardState.lastUpdated = result.lastUpdated;
            renderAll();
            setSyncStatus('connected', 'Live');
        } catch (err) {
            console.error('Add task failed:', err);
            setSyncStatus('error', 'Failed');
        }
    }

    // === POLLING ===
    function startPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(async () => {
            try {
                const data = await apiFetch('/board');
                if (data.error) return;
                // Only update if server state is newer
                if (data.lastUpdated && data.lastUpdated !== (boardState && boardState.lastUpdated)) {
                    boardState = data;
                    renderAll();
                }
            } catch (err) {
                // Silently fail on poll errors
            }
        }, POLL_INTERVAL);
    }

    // === KEYBOARD SHORTCUT ===
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideResetModal();
            hideAddTaskModal();
        }
    });

    // === INIT ===
    loadBoard().then(() => {
        startPolling();
    });
</script>

</body>
</html>
